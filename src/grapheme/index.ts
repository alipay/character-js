/**
 * å­—ç´ ç°‡æˆªå–ã€æ‹†åˆ†
 * @module common/grapheme
 */
import { getGraphemeBreakProperty, UnicodeType } from './util';

const riArr = [
  'ğŸ‡¦ğŸ‡¨', 'ğŸ‡¦ğŸ‡©', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡¦ğŸ‡«', 'ğŸ‡¦ğŸ‡¬', 'ğŸ‡¦ğŸ‡®', 'ğŸ‡¦ğŸ‡±', 'ğŸ‡¦ğŸ‡²', 'ğŸ‡¦ğŸ‡´', 'ğŸ‡¦ğŸ‡¶', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡¦ğŸ‡¸', 'ğŸ‡¦ğŸ‡¹', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡¦ğŸ‡¼', 'ğŸ‡¦ğŸ‡½', 'ğŸ‡¦ğŸ‡¿', 'ğŸ‡§ğŸ‡¦', 'ğŸ‡§ğŸ‡§', 'ğŸ‡§ğŸ‡©', 'ğŸ‡§ğŸ‡ª', 'ğŸ‡§ğŸ‡«', 'ğŸ‡§ğŸ‡¬', 'ğŸ‡§ğŸ‡­', 'ğŸ‡§ğŸ‡®', 'ğŸ‡§ğŸ‡¯', 'ğŸ‡§ğŸ‡±', 'ğŸ‡§ğŸ‡²', 'ğŸ‡§ğŸ‡³', 'ğŸ‡§ğŸ‡´', 'ğŸ‡§ğŸ‡¶', 'ğŸ‡§ğŸ‡·', 'ğŸ‡§ğŸ‡¸', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡§ğŸ‡»', 'ğŸ‡§ğŸ‡¼', 'ğŸ‡§ğŸ‡¾', 'ğŸ‡§ğŸ‡¿', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¨ğŸ‡¨', 'ğŸ‡¨ğŸ‡©', 'ğŸ‡¨ğŸ‡«', 'ğŸ‡¨ğŸ‡¬', 'ğŸ‡¨ğŸ‡­', 'ğŸ‡¨ğŸ‡®', 'ğŸ‡¨ğŸ‡°', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡²', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡¨ğŸ‡µ', 'ğŸ‡¨ğŸ‡·', 'ğŸ‡¨ğŸ‡º', 'ğŸ‡¨ğŸ‡»', 'ğŸ‡¨ğŸ‡¼', 'ğŸ‡¨ğŸ‡½', 'ğŸ‡¨ğŸ‡¾', 'ğŸ‡¨ğŸ‡¿', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡©ğŸ‡¬', 'ğŸ‡©ğŸ‡¯', 'ğŸ‡©ğŸ‡°', 'ğŸ‡©ğŸ‡²', 'ğŸ‡©ğŸ‡´', 'ğŸ‡©ğŸ‡¿', 'ğŸ‡ªğŸ‡¦', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡ªğŸ‡ª', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡ªğŸ‡­', 'ğŸ‡ªğŸ‡·', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡ªğŸ‡¹', 'ğŸ‡ªğŸ‡º', 'ğŸ‡«ğŸ‡®', 'ğŸ‡«ğŸ‡¯', 'ğŸ‡«ğŸ‡°', 'ğŸ‡«ğŸ‡²', 'ğŸ‡«ğŸ‡´', 'ğŸ‡«ğŸ‡·', 'ğŸ‡¬ğŸ‡¦', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡¬ğŸ‡©', 'ğŸ‡¬ğŸ‡ª', 'ğŸ‡¬ğŸ‡«', 'ğŸ‡¬ğŸ‡¬', 'ğŸ‡¬ğŸ‡­', 'ğŸ‡¬ğŸ‡®', 'ğŸ‡¬ğŸ‡±', 'ğŸ‡¬ğŸ‡²', 'ğŸ‡¬ğŸ‡³', 'ğŸ‡¬ğŸ‡µ', 'ğŸ‡¬ğŸ‡¶', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡¬ğŸ‡¸', 'ğŸ‡¬ğŸ‡¹', 'ğŸ‡¬ğŸ‡º', 'ğŸ‡¬ğŸ‡¼', 'ğŸ‡¬ğŸ‡¾', 'ğŸ‡­ğŸ‡°', 'ğŸ‡­ğŸ‡²', 'ğŸ‡­ğŸ‡³', 'ğŸ‡­ğŸ‡·', 'ğŸ‡­ğŸ‡¹', 'ğŸ‡­ğŸ‡º', 'ğŸ‡®ğŸ‡¨', 'ğŸ‡®ğŸ‡©', 'ğŸ‡®ğŸ‡ª', 'ğŸ‡®ğŸ‡±', 'ğŸ‡®ğŸ‡²', 'ğŸ‡®ğŸ‡³', 'ğŸ‡®ğŸ‡´', 'ğŸ‡®ğŸ‡¶', 'ğŸ‡®ğŸ‡·', 'ğŸ‡®ğŸ‡¸', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡¯ğŸ‡ª', 'ğŸ‡¯ğŸ‡²', 'ğŸ‡¯ğŸ‡´', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡°ğŸ‡ª', 'ğŸ‡°ğŸ‡¬', 'ğŸ‡°ğŸ‡­', 'ğŸ‡°ğŸ‡®', 'ğŸ‡°ğŸ‡²', 'ğŸ‡°ğŸ‡³', 'ğŸ‡°ğŸ‡µ', 'ğŸ‡°ğŸ‡·', 'ğŸ‡°ğŸ‡¼', 'ğŸ‡°ğŸ‡¾', 'ğŸ‡°ğŸ‡¿', 'ğŸ‡±ğŸ‡¦', 'ğŸ‡±ğŸ‡§', 'ğŸ‡±ğŸ‡¨', 'ğŸ‡±ğŸ‡®', 'ğŸ‡±ğŸ‡°', 'ğŸ‡±ğŸ‡·', 'ğŸ‡±ğŸ‡¸', 'ğŸ‡±ğŸ‡¹', 'ğŸ‡±ğŸ‡º', 'ğŸ‡±ğŸ‡»', 'ğŸ‡±ğŸ‡¾', 'ğŸ‡²ğŸ‡¦', 'ğŸ‡²ğŸ‡¨', 'ğŸ‡²ğŸ‡©', 'ğŸ‡²ğŸ‡ª', 'ğŸ‡²ğŸ‡«', 'ğŸ‡²ğŸ‡¬', 'ğŸ‡²ğŸ‡­', 'ğŸ‡²ğŸ‡°', 'ğŸ‡²ğŸ‡±', 'ğŸ‡²ğŸ‡²', 'ğŸ‡²ğŸ‡³', 'ğŸ‡²ğŸ‡´', 'ğŸ‡²ğŸ‡µ', 'ğŸ‡²ğŸ‡¶', 'ğŸ‡²ğŸ‡·', 'ğŸ‡²ğŸ‡¸', 'ğŸ‡²ğŸ‡¹', 'ğŸ‡²ğŸ‡º', 'ğŸ‡²ğŸ‡»', 'ğŸ‡²ğŸ‡¼', 'ğŸ‡²ğŸ‡½', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡²ğŸ‡¿', 'ğŸ‡³ğŸ‡¦', 'ğŸ‡³ğŸ‡¨', 'ğŸ‡³ğŸ‡ª', 'ğŸ‡³ğŸ‡«', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡³ğŸ‡®', 'ğŸ‡³ğŸ‡±', 'ğŸ‡³ğŸ‡´', 'ğŸ‡³ğŸ‡µ', 'ğŸ‡³ğŸ‡·', 'ğŸ‡³ğŸ‡º', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡´ğŸ‡²', 'ğŸ‡µğŸ‡¦', 'ğŸ‡µğŸ‡ª', 'ğŸ‡µğŸ‡«', 'ğŸ‡µğŸ‡¬', 'ğŸ‡µğŸ‡­', 'ğŸ‡µğŸ‡°', 'ğŸ‡µğŸ‡±', 'ğŸ‡µğŸ‡²', 'ğŸ‡µğŸ‡³', 'ğŸ‡µğŸ‡·', 'ğŸ‡µğŸ‡¸', 'ğŸ‡µğŸ‡¹', 'ğŸ‡µğŸ‡¼', 'ğŸ‡µğŸ‡¾', 'ğŸ‡¶ğŸ‡¦', 'ğŸ‡·ğŸ‡ª', 'ğŸ‡·ğŸ‡´', 'ğŸ‡·ğŸ‡¸', 'ğŸ‡·ğŸ‡º', 'ğŸ‡·ğŸ‡¼', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¸ğŸ‡§', 'ğŸ‡¸ğŸ‡¨', 'ğŸ‡¸ğŸ‡©', 'ğŸ‡¸ğŸ‡ª', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¸ğŸ‡­', 'ğŸ‡¸ğŸ‡®', 'ğŸ‡¸ğŸ‡¯', 'ğŸ‡¸ğŸ‡°', 'ğŸ‡¸ğŸ‡±', 'ğŸ‡¸ğŸ‡²', 'ğŸ‡¸ğŸ‡³', 'ğŸ‡¸ğŸ‡´', 'ğŸ‡¸ğŸ‡·', 'ğŸ‡¸ğŸ‡¸', 'ğŸ‡¸ğŸ‡¹', 'ğŸ‡¸ğŸ‡»', 'ğŸ‡¸ğŸ‡½', 'ğŸ‡¸ğŸ‡¾', 'ğŸ‡¸ğŸ‡¿', 'ğŸ‡¹ğŸ‡¦', 'ğŸ‡¹ğŸ‡¨', 'ğŸ‡¹ğŸ‡©', 'ğŸ‡¹ğŸ‡«', 'ğŸ‡¹ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡¹ğŸ‡¯', 'ğŸ‡¹ğŸ‡°', 'ğŸ‡¹ğŸ‡±', 'ğŸ‡¹ğŸ‡²', 'ğŸ‡¹ğŸ‡³', 'ğŸ‡¹ğŸ‡´', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡¹ğŸ‡¹', 'ğŸ‡¹ğŸ‡»', 'ğŸ‡¹ğŸ‡¼', 'ğŸ‡¹ğŸ‡¿', 'ğŸ‡ºğŸ‡¦', 'ğŸ‡ºğŸ‡¬', 'ğŸ‡ºğŸ‡²', 'ğŸ‡ºğŸ‡³', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡ºğŸ‡¾', 'ğŸ‡ºğŸ‡¿', 'ğŸ‡»ğŸ‡¦', 'ğŸ‡»ğŸ‡¨', 'ğŸ‡»ğŸ‡ª', 'ğŸ‡»ğŸ‡¬', 'ğŸ‡»ğŸ‡®', 'ğŸ‡»ğŸ‡³', 'ğŸ‡»ğŸ‡º', 'ğŸ‡¼ğŸ‡«', 'ğŸ‡¼ğŸ‡¸', 'ğŸ‡½ğŸ‡°', 'ğŸ‡¾ğŸ‡ª', 'ğŸ‡¾ğŸ‡¹', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡¿ğŸ‡²', 'ğŸ‡¿ğŸ‡¼',
];

// ç”¨äºå¤„ç†è¡¨æƒ…çš„æ‹†åˆ†
enum GBState {
  Initial = 0, // åˆå§‹åŒ–
  ExtendOrZWJ = 1, // é‡åˆ°éœ€è¦ç»„åˆè¡¨æƒ…çš„æ—¶å€™
  NotBoundary = 2, // ç»“æŸ
}

// å®šä¹‰æ˜¯å¦éœ€è¦æ‹†åˆ†å­—ç¬¦
const NotBreak = 0; // ä¸éœ€è¦æ‹†åˆ†
const BreakStart = 1; // éœ€è¦æ‹†åˆ†

let gbState = GBState.Initial;
let ri = 0; // ç”¨äºå›½æ——çš„æ‹†åˆ† ğŸ‡· + ğŸ‡º = ğŸ‡·ğŸ‡º

const highSurrogateStart = 0xD800;
const highSurrogateEnd = 0xDBFF;
const lowSurrogateStart = 0xDC00;
const lowSurrogateEnd = 0xDFFF;

// åˆ¤æ–­ç ç‚¹æ˜¯å¦åœ¨é«˜\ä½ä»£ç†é¡¹
const isSurrogate = (str: string, pos: number): boolean => {
  return str.charCodeAt(pos) >= highSurrogateStart && str.charCodeAt(pos) <= highSurrogateEnd &&
        str.charCodeAt(pos + 1) >= lowSurrogateStart && str.charCodeAt(pos + 1) <= lowSurrogateEnd;
};

// ä»UTF-16å­—ç¬¦ä¸²ä¸­è·å–Unicodeä»£ç ç‚¹
// è¿™é‡Œæ˜¯å¤„ç†Unicode ä»£ç†é¡¹å¯¹çš„,å¦‚æœä¸æ‡‚ä»£ç†é¡¹è¦å­¦ä¹ ä¸‹
// ç®€è€Œè¨€ä¹‹ï¼šé«˜ä»£ç†é¡¹å­—ç¬¦(0xD800 - 0xDBFF) å¿…é¡»å§‹ç»ˆä¸ä½ä»£ç†é¡¹å­—ç¬¦(0xDC00 - 0xDFFF)æˆå¯¹ã€‚
const codePointAt = (str: string, key: number): number => {
  const idx = key || 0;
  const code = str.charCodeAt(idx);

  if (code >= highSurrogateStart && code <= highSurrogateEnd && idx < str.length - 1) {
    const hi = code;
    const low = str.charCodeAt(idx + 1);
    if (low >= lowSurrogateStart && low <= lowSurrogateEnd) {
      // ä»åŸºç¡€å¹³é¢å…¬å¼ ((hi - 0xD800) * 0x400) + (low - 0xDC00) + 0x10000 åæ¨å›å»å¾—åˆ°ä¸€ä¸ªè¾…åŠ©å¹³é¢çš„unicodeç ç‚¹ã€‚
      return ((hi - highSurrogateStart) * 0x400) + (low - lowSurrogateStart) + 0x10000;
    }
    return hi;
  }
  if (code >= lowSurrogateStart && code <= lowSurrogateEnd && idx >= 1) {
    const hi = str.charCodeAt(idx - 1);
    const low = code;
    if (hi >= highSurrogateStart && hi <= highSurrogateEnd) {
      // åŒä¸Š
      return ((hi - highSurrogateStart) * 0x400) + (low - lowSurrogateStart) + 0x10000;
    }
    return low;
  }

  return code;
};

// åœ¨unicodeä¸­å›ºå®šäº†ä¸€äº›è§„åˆ™ï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥æ‹†åˆ†ï¼Œé‚£äº›ä¸å¯ä»¥æ‹†åˆ†
const shouldBreak = (start: number, mid: number[], end: number): number => {
  const all = [start].concat(mid).concat([end]);
  const previous = all[all.length - 2];
  const next = end;

  // for GB12, GB13
  if (previous !== UnicodeType.RI) {
    ri = 0;
  }

  // GB11: \p{Extended_Pictographic} Extend* ZWJ x \p{Extended_Pictographic}
  // è¡¨æƒ…çš„æ‹†åˆ†æ–¹å¼ï¼šä¸è¦åœ¨è¡¨æƒ…ç¬¦å·ä¿®é¥°ç¬¦åºåˆ—æˆ–è¡¨æƒ…ç¬¦å· zwj åºåˆ—ä¸­ä¸­æ–­ã€‚
  // switch caseçš„å†™æ³•æ˜¯ä¸ºäº†éå†
  switch (gbState) {
    case GBState.NotBoundary:
    case GBState.Initial:
      if (previous === UnicodeType.EP) {
        gbState = GBState.ExtendOrZWJ;
      } else {
        gbState = GBState.Initial;
      }
      break;
    case GBState.ExtendOrZWJ:
      if (previous === UnicodeType.Extend) {
        gbState = GBState.ExtendOrZWJ;
      } else if (previous === UnicodeType.ZWJ && next === UnicodeType.EP) {
        // çœ‹è¿™ä¸ªåˆ¤æ–­å‰ä¸€ä¸ªå­—ç¬¦æ˜¯ZWJåä¸€ä¸ªæ˜¯EPå°±ä¸æ‹†
        gbState = GBState.NotBoundary;
      } else {
        gbState = GBState.Initial;
      }
      break;
  }
  // ä¸è¦åœ¨ CR å’Œ LF ä¹‹é—´ä¸­æ–­ã€‚å¦åˆ™ï¼Œæ‰“ç ´ä¹‹å‰å’Œä¹‹åçš„æ§åˆ¶ã€‚ GB3-GB5
  // GB3
  if (previous === UnicodeType.CR && next === UnicodeType.LF) {
    return NotBreak;
  }
  // GB4
  if (
    previous === UnicodeType.Control ||
    previous === UnicodeType.CR ||
    previous === UnicodeType.LF
  ) {
    return BreakStart;
  }
  // GB5
  if (next === UnicodeType.Control || next === UnicodeType.CR || next === UnicodeType.LF) {
    return BreakStart;
  }
  // ä¸è¦æ‰“æ–­éŸ©è¯­éŸ³èŠ‚åºåˆ—ã€‚GB6-GB8
  // GB6
  if (
    previous === UnicodeType.L &&
      (next === UnicodeType.L ||
      next === UnicodeType.V ||
      next === UnicodeType.LV ||
      next === UnicodeType.LVT)
  ) {
    return NotBreak;
  }
  // GB7
  if (
    (previous === UnicodeType.LV || previous === UnicodeType.V) &&
    (next === UnicodeType.V || next === UnicodeType.T)
  ) {
    return NotBreak;
  }
  // GB8
  if ((previous === UnicodeType.LVT || previous === UnicodeType.T) && next === UnicodeType.T) {
    return NotBreak;
  }
  // åœ¨æ‰©å±•å­—ç¬¦æˆ– ZWJ ä¹‹å‰ä¸è¦ä¸­æ–­ã€‚GB9
  if (next === UnicodeType.Extend || next === UnicodeType.ZWJ) {
    return NotBreak;
  }
  // GB9aå’ŒGB9bè§„åˆ™ä»…é€‚ç”¨äºæ‰©å±•å­—ç´ ç°‡ï¼š
  // ä¸è¦åœ¨ SpacingMarks ä¹‹å‰æˆ– Prepend å­—ç¬¦ä¹‹åæ‰“æ–­ã€‚
  // GB9a
  if (next === UnicodeType.SM) {
    return NotBreak;
  }
  // // GB9b
  if (previous === UnicodeType.Prepend) {
    return NotBreak;
  }
  // ä¸è¦åœ¨è¡¨æƒ…ç¬¦å·ä¿®é¥°ç¬¦åºåˆ—æˆ–è¡¨æƒ…ç¬¦å· zwj åºåˆ—ä¸­ä¸­æ–­ã€‚
  // GB11
  if (gbState === GBState.NotBoundary) {
    return NotBreak;
  }
  // GB12 13
  // å¦‚æœåœ¨ä¸­æ–­ç‚¹ä¹‹å‰æœ‰å¥‡æ•°ä¸ª RI å­—ç¬¦ï¼Œåˆ™ä¸è¦åœ¨åŒºåŸŸæŒ‡ç¤ºç¬¦ (RI) ç¬¦å·ä¹‹é—´ä¸­æ–­ã€‚
  // ğŸ‡® + ğŸ‡¸ = ğŸ‡®ğŸ‡¸ å›½æ——æ˜¯é€šè¿‡2ä¸ªåŒºåŸŸæŒ‡ç¤ºç¬¦ (RI)è¿åœ¨ä¸€èµ·ç»„åˆè€Œæˆçš„ï¼Œæ‹†å¼€å°±ä¸æ˜¯å›½æ——äº†ï¼Œ
  // è€Œä¸”æ¯2ä¸ªRIå°±è¦æ‹†ä¸€æ¬¡ï¼Œå› ä¸º4ä¸ªRIè¿åœ¨ä¸€èµ· = 2ä¸ªå›½æ——ï¼Œ2ä¸ªå›½æ——ä¹‹é—´ä¹Ÿè¦æ‹†ä¸€æ¬¡
  if (previous === UnicodeType.RI && next === UnicodeType.RI && ri % 2 === 0) {
    ri++;
    return NotBreak;
  }
  // GB999 å¦åˆ™å…¨éƒ¨æ–­å¼€
  return BreakStart;
};

// ä»å‰å¾€åï¼Œé€æ­¥éå†ä¸‹ä¸€ä¸ªå­—ç¬¦
// str: å®Œæ•´çš„å­—ç¬¦ä¸²ï¼Œindex: å½“å‰éå†çš„ä½ç½®
const nextBreak = (str: string, index: number): number => {
  // å…œåº•å¤„ç†
  if (index < 0) {
    return 0;
  }
  // å…œåº•å¤„ç†
  if (index >= str.length - 1) {
    return str.length;
  }
  // æ¯åˆ°ä¸‹ä¸€ä¸ªéå†å‘¨æœŸçš„æ—¶å€™é‡ç½®ä¸€ä¸‹
  gbState = GBState.Initial;
  ri = 0; // ç”¨äºå›½æ——çš„æ‹†åˆ† ğŸ‡· + ğŸ‡º = ğŸ‡·ğŸ‡º
  // prevå¯ä»¥ç†è§£çš„å‰ä¸€ä¸ªå­—ç¬¦
  const prev = getGraphemeBreakProperty(codePointAt(str, index));
  // å‰ä¸€ä¸ªå­—ç¬¦å’Œåä¸€ä¸ªå­—ç¬¦ä¹‹é—´çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ä¸æ‹†åˆ†çš„åŒºé—´éƒ¨åˆ†
  const mid = [];
  for (let i = index + 1; i < str.length; i++) {
    // é«˜ä»£ç†é¡¹éœ€è¦è·³è¿‡ä¸€æ¬¡æ‹†åˆ†å­—ç¬¦ï¼Œä»–æ˜¯ç”±ä¸¤ä¸ªå­—ç¬¦ç»„åˆçš„ï¼Œæ‰€ä»¥éœ€è¦è·³è¿‡
    // æˆ–è€…å¯ä»¥ç®€å•çš„å†™æˆ(æ²¡æµ‹è¿‡ï¼Œä½†æ˜¯åº”è¯¥æ˜¯ä¸€ä¸ªæ„æ€)ï¼šconst code = str.codePointAt(i);  code > 65535 && continue;
    if (isSurrogate(str, i - 1)) {
      continue;
    }
    // prevå¯ä»¥ç†è§£çš„åä¸€ä¸ªå­—ç¬¦
    const next = getGraphemeBreakProperty(codePointAt(str, i));
    // æ ¹æ®è§„åˆ™åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹†åˆ†ï¼Œä¸æ‹†åˆ†çš„è¯å°±æŠŠè¿™ä¸ªå­—ç¬¦æ”¾è¿›midé‡Œé¢å»

    if (shouldBreak(prev, mid, next)) {
      ri = 0;
      return i;
    }
    if (next === UnicodeType.RI && riArr.indexOf(str.slice(i - 2, i + 2)) === -1) {
      return i;
    }
    mid.push(next);
  }
  return str.length;
};

/**
 * ç”¨äºå¯¹å­—ç¬¦ä¸²è¿›è¡Œå­—ç´ ç°‡çš„æ‹†åˆ†ï¼Œç±»ä¼¼äºAPI Intl.Segmenter
 *
 * åŸºäºunicode tr29:UNICODE TEXT SEGMENTATIONå¼€å‘çš„ä¸€ç§å­—ç´ ç°‡æ‹†åˆ†èƒ½åŠ›
 *
 * å­—ç´ ç°‡ï¼šç”¨æˆ·æ„ŸçŸ¥çš„å­—ç¬¦ï¼Œä¾‹å¦‚ï¼šğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¿ğŸ¤™ï¼Œç”¨æˆ·æ„ŸçŸ¥å°±æ˜¯6ä¸ªâ€œå­—ç¬¦â€ã€‚
 *
 * æœ¬å‡½æ•°æ—¨åœ¨å°†æ‰€æœ‰åŸºç¡€å­—ç¬¦ä¸²æŒ‰ç…§â€œç”¨æˆ·æ„ŸçŸ¥å­—ç¬¦â€ï¼ˆå­—ç¬¦ç°‡ï¼‰è¿›è¡Œè¾¹ç•Œæ‹†åˆ†ï¼Œä»¥å¾—åˆ°å®Œæ•´çš„â€œè§†è§‰å­—ç¬¦â€ã€‚
 *
 * æ”¯æŒå„ç§è¯­è¨€ã€éŸ³èŠ‚ã€Emojiã€ç‰¹æ®Šç¬¦å·...çš„è§†è§‰æ‹†åˆ†
 *
 *
 * graphemeSplit('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¿ğŸ¤™'); // returns ["ğŸ§‘ğŸ¼â€ğŸ¦°", "â¤ï¸â€ğŸ©¹", "ğŸ„ğŸ»â€â™€ï¸", "ğŸ‘¨ğŸ½â€ğŸ¤", "ğŸ‘©ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ¿", "ğŸ¤™"]
 *
 * graphemeSplit('LÌoÍ‚rÌŒeÌ§mÌ…'); // returns ["LÌ","oÍ‚","rÌŒ","eÌ§","mÌ…"]
 *
 * graphemeSplit('á„ƒá…§á„‰á…°'); // returns ["á„ƒá…§","á„‰á…°"]
 *
 * graphemeSplit('à¤…à¤¨à¥à¤šà¥à¤›à¥‡à¤¦'); // returns ["à¤…","à¤¨à¥","à¤šà¥","à¤›à¥‡","à¤¦"]
 *
 * graphemeSplit('ZÍ‘Í«ÍƒÍªÌ‚Í«Ì½ÍÌ´Ì™Ì¤ÌÍ‰ÍšÌ¯ÌÌ ÍAÍ«Í—Ì´Í¢ÌµÌœÌ°Í”LÍ¨Í§Í©Í˜Ì GÌ‘Í—ÌÌ…Í›ÍÌ´Ì»ÍˆÍÍ”Ì¹OÍ‚ÌŒÌŒÍ˜Ì¨ÌµÌ¹Ì»ÌÌ³!Ì¿Ì‹Í¥Í¥Ì‚Í£ÌÌÌÍÍœÍ–Ì¬Ì°Ì™Ì—'); // returns ["ZÍ‘Í«ÍƒÍªÌ‚Í«Ì½ÍÌ´Ì™Ì¤ÌÍ‰ÍšÌ¯ÌÌ Í","AÍ«Í—Ì´Í¢ÌµÌœÌ°Í”","LÍ¨Í§Í©Í˜Ì ","GÌ‘Í—ÌÌ…Í›ÍÌ´Ì»ÍˆÍÍ”Ì¹","OÍ‚ÌŒÌŒÍ˜Ì¨ÌµÌ¹Ì»ÌÌ³","!Ì¿Ì‹Í¥Í¥Ì‚Í£ÌÌÌÍÍœÍ–Ì¬Ì°Ì™Ì—"]
 *
 *
 * @param {string} str éœ€è¦æ‹†åˆ†çš„å­—ç¬¦ä¸²
 * @returns è¿”å›ç›®æ ‡æ•°ç»„ string[]
 * graphemeSplit('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸') // return ['ğŸ§‘ğŸ¼â€ğŸ¦°','â¤ï¸â€ğŸ©¹','ğŸ„ğŸ»â€â™€ï¸']
 */
const graphemeSplit = (str: string): string[] => {
  // è¿”å›çš„æ•°ç»„
  const res = [];
  // æ ‡è¯†å­—ç¬¦çš„éå†åˆ°çš„ä¸‹æ ‡
  let index = 0;
  // æ ‡è¯†åœ¨å“ªä¸ªä½ç½®çš„ä¸‹æ ‡æ‹†åˆ†å­—ç¬¦
  let brk = 0;
  // éå†å¾—å‡ºæœ€ç»ˆçš„å­—ç¬¦
  while ((brk = nextBreak(str, index)) < str.length) {
    str.slice(index, brk) && res.push(str.slice(index, brk));
    index = brk;
  }
  // å¦‚æœå½“å‰ä¸‹æ ‡æ ‡è®°åœ¨strä»¥å†…ï¼Œå°±æŠŠè¿™ä¸ªå­—ç¬¦æ”¾è¿›éœ€è¦è¿”å›çš„æ•°ç»„é‡Œ
  if (index < str.length) {
    str.slice(index) && res.push(str.slice(index));
  }
  return res;
};

/**
 * æä¾›é’ˆå¯¹ä¸€æ®µå­—ç¬¦ä¸²æŒ‰ç…§è§†è§‰é•¿åº¦ æˆ–è€… é€»è¾‘é•¿åº¦è¿›è¡Œæˆªå–çš„èƒ½åŠ›ã€‚
 *
 * ä¾‹å­1ï¼šæŒ‰ç…§è§†è§‰é•¿åº¦æˆªå–ä¸€æ®µemojiå­—ç¬¦ï¼ŒgraphemeSubstr('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤', 1, 4) === 'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤'
 *
 *        å…¶ä¸­â€œ1â€è¡¨ç¤º ä»¥è§†è§‰é•¿åº¦åˆ’åˆ†ï¼šä»å·¦å¼€å§‹ç¬¬1ä¸ªâ€œè§†è§‰å­—ç¬¦â€ï¼ˆ0æ˜¯èµ·å§‹ä½ç½®ï¼‰
 *        å…¶ä¸­â€œ4â€è¡¨ç¤º ä»¥è§†è§‰é•¿åº¦åˆ’åˆ†ï¼šä»å·¦å¼€å§‹ç¬¬4ä¸ªâ€œè§†è§‰å­—ç¬¦â€
 *
 *        graphemeSubstr('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤', 1, 4)è¡¨ç¤ºå–ç¬¬1-4ä¸ªâ€œè§†è§‰å­—ç¬¦â€çš„å­—ç¬¦ä¸²'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤'
 *
 * ä¾‹å­2ï¼šæŒ‰ç…§è§†è§‰é•¿åº¦æˆªå–ä¸€æ®µemojiå­—ç¬¦ï¼Œä½†æ˜¯é™åˆ¶å–å‡ºçš„å­—ç¬¦çš„æœ€å¤§é€»è¾‘é•¿åº¦ä¸º13
 *
 *          graphemeSubstr('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤', 1, 4, 13) === 'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸'
 *
 *        å…¶ä¸­â€œ13â€è¡¨ç¤ºï¼Œå–ç¬¬1-4ä¸ªâ€œè§†è§‰å­—ç¬¦â€çš„å­—ç¬¦ä¸² åŒæ—¶é™åˆ¶å–å‡ºçš„å­—ç¬¦ä¸²çš„æœ€å¤§é€»è¾‘é•¿åº¦ä¸º13
 *        ä¾‹å­1ä¸­ å–å‡ºçš„'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤'.length === 19, 19è¶…è¿‡äº†13ï¼Œæ‰€ä»¥ä¼šå‡æ‰æœ€åä¸€ä¸ªå­—ç¬¦ğŸ‘¨ğŸ½â€ğŸ¤
 *
 *        'ğŸ‘¨ğŸ½â€ğŸ¤'.length === 7, æ‰€ä»¥æœ€åå–å‡ºçš„å­—ç¬¦ä¸º'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸'
 *        å¦‚æœ'ğŸ‘¨ğŸ½â€ğŸ¤'.length === 5, 19 - 5 ä¾æ—§å¤§äº13ï¼Œ å°±ä¼šå†å‡æ‰ä¸€ä¸ªå­—ç¬¦ï¼Œä»¥æ­¤ç±»æ¨ã€‚
 *
 * @param {string} str å­—ç¬¦ä¸²
 * @param {number} start å¼€å§‹ä½ç½®(è§†è§‰é•¿åº¦)ï¼Œå¿…é¡»å¤§äº0ï¼Œä¸”å°äºend
 * @param {number} end ç»“æŸä½ç½®(è§†è§‰é•¿åº¦)ï¼Œå¿…é¡»å¤§äº0ï¼Œä¸”å¤§äºstartï¼ŒgraphemeSubstr('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤', 1, 4) === 'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤'
 * @param {number} maxLength éå¿…å¡«ï¼Œå¦‚å¡«å†™äº†ä¼šé™åˆ¶è¾“å‡ºçš„æœ€å¤§ç‰©ç†é•¿åº¦ï¼Œå¦‚ï¼šgraphemeSubstr('ğŸ§‘ğŸ¼â€ğŸ¦°â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸ğŸ‘¨ğŸ½â€ğŸ¤', 1, 4, 13) === 'â¤ï¸â€ğŸ©¹ğŸ„ğŸ»â€â™€ï¸'
 * @returns string æˆªå–çš„å­—ç¬¦ä¸²
 */
const graphemeSubstr = (str: string, start: number, end: number, maxLength?: number): string => {
  // è´Ÿæ•° || start > endçš„æƒ…å†µä¸å¤„ç†
  if (start < 0 || end < 0 || (maxLength && maxLength < 0) || start > end) {
    return '';
  }
  const arr = graphemeSplit(str);
  // æ²¡æœ‰é™åˆ¶ç‰©ç†é•¿åº¦å°±ç›´æ¥ä»æ•°æ®é‡Œé¢æˆªå–
  if (!maxLength) {
    return arr.slice(start, end).join('');
  }
  const _arr = arr.slice(start, end);
  const _strLength = _arr.join('').length;
  // é™åˆ¶ç‰©ç†é•¿åº¦å¤§äºæ•´ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ä¹Ÿç›´æ¥è¿”å›
  if (_strLength <= maxLength) {
    return _arr.join('');
  }

  let num = 0;
  let tarArr: string[] = _arr;
  // ä»æœ€åé¢å¼€å§‹éå†
  for (let i = _arr.length - 1; i > -1; i--) {
    const l = _arr[i].length || 0;
    // å­—ç¬¦é•¿åº¦æ¯”è¾ƒï¼Œä¸²å­—ç¬¦æ€»é•¿åº¦-æœ€åä¸€ä¸ªå­—ç¬¦çš„é•¿åº¦ > ç‰©ç†é™åˆ¶é•¿åº¦ å°±ç»§ç»­éå†ã€‚å¦åˆ™å°±é€€å‡ºå¾ªç¯
    if (_strLength - (l + num) > maxLength) {
      num = l + num;
    } else {
      tarArr = tarArr.slice(0, i);
      break;
    }
  }
  return tarArr.join('');
};

export {
  graphemeSplit,
  graphemeSubstr,
};
